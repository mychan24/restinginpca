---
title: "MuSuDemo_nopreproc"
output: github_document
---

## Outline
##### Correlation matirx (subj1-subj3) -> rectangular matrix [sessions x edges by network by subject] -> center across sessions -> SVD

## Objectives
Here, we illustrate the results when the rectangular matrix (sessions x edges by network by subject) is analyzed by SVD after the each edge is centered (center across sessions).

```{r cars, echo = FALSE, include = FALSE}
suppressMessages(library(psych))
suppressMessages(library(DistatisR))
suppressMessages(library(tidyr))
suppressMessages(library(magrittr))
suppressMessages(library(DistatisR))
suppressMessages(library(PTCA4CATA))
suppressMessages(library(ExPosition))
suppressMessages(library(InPosition))
suppressMessages(library(superheat))
suppressMessages(library(gridExtra))
suppressMessages(library(ggplotify))
suppressMessages(library(grid))
suppressMessages(library(pals))
# Read functions
tool.path <- "../tools/"
source(paste0(tool.path,"SScomm.R"))
source(paste0(tool.path,"vec2sqmat.R"))
```


## Read cube data (z(correlation) matrix) and the information for communities

```{r data, echo = FALSE, include = FALSE}
zmat.path <- "../data/zmat"
load(paste0(zmat.path,"/sub-MSC01_zcube_rcube.RData"))
# read parcel labels
parcel.comm.path <- "../data/parcel_community"
vox.des <- read.table(paste0(parcel.comm.path,"/sub-MSC01_node_parcel_comm.txt"),sep = ",")
colnames(vox.des) <- c("NodeID","VertexID","Comm")
# rename communities
#--- read the file with community information: label number & community name & color & abbreviation for community name
CommName <- read.csv(paste0(parcel.comm.path,"/systemlabel.txt"),sep = ",",header = FALSE)
colnames(CommName) <- c("Comm","CommLabel","CommColor","CommLabel.short")
#--- create three columns in the original table of community information: name, color, abbreviation
for(i in 1:nrow(CommName)){
  vox.des$Comm.recode[vox.des$Comm==CommName$Comm[i]] <- as.character(CommName$CommLabel[i])
  vox.des$Comm.Col[vox.des$Comm==CommName$Comm[i]] <- as.character(CommName$CommColor[i])
  vox.des$Comm.rcd[vox.des$Comm==CommName$Comm[i]] <- as.character(CommName$CommLabel.short[i])
}
#--- Create design matrix for communities
vox.des.mat <- makeNominalData(as.matrix(vox.des$Comm.rcd))
colnames(vox.des.mat) <- sub(".","",colnames(vox.des.mat))

#--- Create color for each communities
Comm.col <- list(oc = as.matrix(vox.des$Comm.Col), gc = as.matrix(CommName$CommColor))
rownames(Comm.col$oc) <- vox.des$NodeID
rownames(Comm.col$gc) <- CommName$CommLabel.short
```

This is a data cube of correlation: ROIs x ROIs x 10 sessions

```{r check, echo = TRUE, include = TRUE}
# Dimensions
dim(cubes$rcube)
```

## Read the rectangular table
```{r gt, echo = FALSE, include = FALSE}
# the labels for each intersection of the correlation matirx
load(paste0("../data/grandatble_and_labels_20190204.Rdata")) # read the labels of grandtable
# Categorize columns by between or within edges
#--- Create new column of sub-edgetype
sprintf('%s_%s',labels$subjects_label,labels$wb)
labels[,'subjects_wb'] <- sprintf('%s_%s',labels$subjects_label,labels$wb)
## get data from subject 1
gt.sub1 <- gt[,which(labels$subjects_label == "sub01")]
labels.sub1 <- labels[which(labels$subjects_label == "sub01"),]

# > Centered across sessions
gt.sub1_centXsess <- expo.scale(gt.sub1, center = TRUE, scale = FALSE)

```

### The grand table:
```{r gt_heatmap, echo = FALSE}
superheat(gt.sub1_centXsess,
          membership.cols = labels.sub1$subjects_edge_label,
          membership.rows = c(1:10),
          clustering.method = NULL,
          heat.col.scheme = "viridis",
          left.label.size = 0.05,
          bottom.label.size = 0.05,
          y.axis.reverse = TRUE,
          left.label.text.size = 3,
          bottom.label.text.size = 2,
          left.label.text.alignment = "left",
          grid.vline = FALSE
)
```

### the heatmap with columns arranged according to edgetype

```{r gt_heatmap_bw, echo = FALSE}
superheat(gt.sub1_centXsess,
          membership.cols = labels.sub1$subjects_wb,
          membership.rows = c(1:10),
          clustering.method = NULL,
          heat.col.scheme = "viridis",
          left.label.size = 0.05,
          bottom.label.size = 0.05,
          y.axis.reverse = TRUE,
          left.label.text.size = 3,
          bottom.label.text.size = 2,
          left.label.text.alignment = "left",
          grid.vline = FALSE
)
```


## SVD

The data are transposed so that the rows are now different edges of different subject and the columns are different sessions. The data are centered across sessions (each edge is centered).

```{r gt_svd}
# Use subject_edge_label as column names
colnames(gt.sub1_centXsess) <- labels.sub1$subjects_edge_label
# SVD on the rectangular data ------------------------
pca.res.subj <- epPCA(t(gt.sub1_centXsess),scale = FALSE, center = FALSE, DESIGN = labels.sub1$subjects_edge_label, make_design_nominal = TRUE, graphs = FALSE)
# check dimension
dim(t(gt.sub1_centXsess))
```

### Check the contribution of each variable
```{r contribution}
cI <- pca.res.subj$ExPosition.Data$ci
#--- get the sum of contribution for each edge
c_edge <- labels.sub1$subjects_edge_label %>% as.matrix %>% makeNominalData %>% t %>% "%*%"(cI)
rownames(c_edge) <- sub(".","",rownames(c_edge))
#--- compute the sums of squares of each variable for each component
absCtrEdg <- as.matrix(c_edge) %*% diag(pca.res.subj$ExPosition.Data$eigs)
#--- get the contribution for component 1 AND 2 by sum(SS from 1, SS from 2)/sum(eigs 1, eigs 2)
edgCtr12 <- (absCtrEdg[,1] + absCtrEdg[,2])/(pca.res.subj$ExPosition.Data$eigs[1] + pca.res.subj$ExPosition.Data$eigs[2])
edgCtr23 <- (absCtrEdg[,3] + absCtrEdg[,2])/(pca.res.subj$ExPosition.Data$eigs[2] + pca.res.subj$ExPosition.Data$eigs[3])
#--- the important variables are the ones that contribute more than or equal to the average
importantEdg12 <- (edgCtr12 >= 1/length(edgCtr12))
importantEdg23 <- (edgCtr23 >= 1/length(edgCtr23))
importantEdg1 <- (cI[,1] >= 1/length(cI[,1]))
importantEdg2 <- (cI[,2] >= 1/length(cI[,2]))
#--- color for networks
col4ImportantEdg <- unique(pca.res.subj$Plotting.Data$fi.col) # get colors
col4NS <- 'gray90' # set color for not significant edges to gray
col4ImportantEdg[!importantEdg12] <- col4NS # replace them in the color vector

```

## Inference

To have a (relatively) clearer view of the results, we compute the mean for each edge (or edge type) that we are interested in.

```{r mean_fi}
# Compute means of factor scores for different edges----
#mean.fi <- getMeans(pca.res.subj$ExPosition.Data$fi, labels.sub1$subjects_edge_label) # with t(gt)

#BootCube.Comm <- Boot4Mean(pca.res.subj$ExPosition.Data$fi,
#                           design = labels.sub1$subjects_edge_label,
#                           niter = 100,
#                           suppressProgressBar = TRUE)


# Compute means of factor scores for different types of edges
#mean.fi.bw <- getMeans(pca.res.subj$ExPosition.Data$fi, labels.sub1$subjects_wb) # with t(gt)
#BootCube.Comm.bw <- Boot4Mean(pca.res.subj$ExPosition.Data$fi,
#                           design = labels.sub1$subjects_wb,
#                           niter = 100,
#                           suppressProgressBar = TRUE)

```

## Plot

First, we plot the 10 sessions

```{r plot_fj, echo = FALSE}
plot.fj <- createFactorMap(pca.res.subj$ExPosition.Data$fj) # with t(gt)
plot.fj$zeMap
```

Next, we plot each edges

```{r f_sqmat, echo=F, fig.show = 'hide'}
#--- show column factor scores in a square matrix
fi1_sqmat <- vec2sqmat(pca.res.subj$ExPosition.Data$fi[,1])
heat_fi1 <- superheat(fi1_sqmat, y.axis.reverse = T,
          membership.rows =vox.des$Comm.rcd,
          membership.cols =vox.des$Comm.rcd,                    
          left.label.col=Comm.col$gc[order(rownames(Comm.col$gc))],
          bottom.label.col=Comm.col$gc[order(rownames(Comm.col$gc))],
          left.label.size = 0.08,
          bottom.label.size = 0.05,
          extreme.values.na = FALSE,
          heat.lim = c(-.6, .6),
          heat.pal = kovesi.diverging_bwr_40_95_c42(200),
          heat.pal.values = c(0,0.35,0.5,0.65,1),
          left.label.text.size = 3,
          bottom.label.text.size = 2,
          left.label.text.col = c(rep("black",8),rep("white",2),rep("black",3),"white",rep("black",3),rep("white",2)),
          bottom.label.text.col = c(rep("black",8),rep("white",2),rep("black",3),"white",rep("black",3),rep("white",2)),
          title="Node x Node Matrix of factor scores (component 1)")

fi2_sqmat <- vec2sqmat(pca.res.subj$ExPosition.Data$fi[,2])
heat_fi2 <- superheat(fi2_sqmat, y.axis.reverse = T,
          membership.rows =vox.des$Comm.rcd,
          membership.cols =vox.des$Comm.rcd,                    
          left.label.col=Comm.col$gc[order(rownames(Comm.col$gc))],
          bottom.label.col=Comm.col$gc[order(rownames(Comm.col$gc))],
          left.label.size = 0.08,
          bottom.label.size = 0.05,
          extreme.values.na = FALSE,
          heat.lim = c(-.6, .6),
          heat.pal = kovesi.diverging_bwr_40_95_c42(200),
          heat.pal.values = c(0,0.35,0.5,0.65,1),
          left.label.text.size = 3,
          bottom.label.text.size = 2,
          left.label.text.col = c(rep("black",8),rep("white",2),rep("black",3),"white",rep("black",3),rep("white",2)),
          bottom.label.text.col = c(rep("black",8),rep("white",2),rep("black",3),"white",rep("black",3),rep("white",2)),
          title="Node x Node Matrix of factor scores (component 2)")
```

```{r grid_heat_fi, echo=F, fig.height=8, fig.width=14}
gridExtra::grid.arrange(as.grob(heat_fi1$plot), as.grob(heat_fi2$plot), ncol=2,
                        top = textGrob("Node x Node Matrix of Factor Score",gp=gpar(fontsize=18,font=3)))
```

If we plot only the edges that significantly contribute to the component

```{r f_sig_sqmat, echo=F, fig.show = 'hide'}
fi1_sig <- pca.res.subj$ExPosition.Data$fi[,1]
fi1_sig[!importantEdg1] <- 0
fi1_sig_sqmat <- vec2sqmat(fi1_sig)
heat_sig_fi1 <- superheat(fi1_sig_sqmat, y.axis.reverse = T,
          membership.rows =vox.des$Comm.rcd,
          membership.cols =vox.des$Comm.rcd,                    
          left.label.col=Comm.col$gc[order(rownames(Comm.col$gc))],
          bottom.label.col=Comm.col$gc[order(rownames(Comm.col$gc))],
          left.label.size = 0.08,
          bottom.label.size = 0.05,
          extreme.values.na = FALSE,
          heat.lim = c(-.6, .6),
          heat.pal = kovesi.diverging_bwr_40_95_c42(200),
          heat.pal.values = c(0,0.35,0.5,0.65,1),
          left.label.text.size = 3,
          bottom.label.text.size = 2,
          left.label.text.col = c(rep("black",8),rep("white",2),rep("black",3),"white",rep("black",3),rep("white",2)),
          bottom.label.text.col = c(rep("black",8),rep("white",2),rep("black",3),"white",rep("black",3),rep("white",2)),
          title="Node x Node Matrix of factor scores (component 1)")

fi2_sig <- pca.res.subj$ExPosition.Data$fi[,2]
fi2_sig[!importantEdg2] <- 0
fi2_sig_sqmat <- vec2sqmat(fi2_sig)
heat_sig_fi2 <- superheat(fi2_sig_sqmat, y.axis.reverse = T,
          membership.rows =vox.des$Comm.rcd,
          membership.cols =vox.des$Comm.rcd,                    
          left.label.col=Comm.col$gc[order(rownames(Comm.col$gc))],
          bottom.label.col=Comm.col$gc[order(rownames(Comm.col$gc))],
          left.label.size = 0.08,
          bottom.label.size = 0.05,
          extreme.values.na = FALSE,
          heat.lim = c(-.6, .6),
          heat.pal = kovesi.diverging_bwr_40_95_c42(200),
          heat.pal.values = c(0,0.35,0.5,0.65,1),
          left.label.text.size = 3,
          bottom.label.text.size = 2,
          left.label.text.col = c(rep("black",8),rep("white",2),rep("black",3),"white",rep("black",3),rep("white",2)),
          bottom.label.text.col = c(rep("black",8),rep("white",2),rep("black",3),"white",rep("black",3),rep("white",2)),
          title="Node x Node Matrix of factor scores (component 2)")


```

```{r grid_heat_sig_fi, echo=F, fig.height=8, fig.width=14}
gridExtra::grid.arrange(as.grob(heat_sig_fi1$plot), as.grob(heat_sig_fi2$plot), ncol=2,
                        top = textGrob("Node x Node Matrix of Factor Score (significant edges)",gp=gpar(fontsize=18,font=3)))
```
