---
title: "DiSTATIS on edges derived from Gordon Group parcellation (n nodes = 333) simmulations NOT TMS"
output: github_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,collapse=TRUE, comment="##")
```

## Objectives
This attempt perform DiSTATIS on mean connectivity of edges (e.g., mean connectivity between DMN and FPN, mean connectivity within DMN) of common networks across participants. The results from this analysis can be compared to regular DiSTATIS of rs*f*MRI. 

```{r cars, echo = FALSE, include = FALSE}
suppressMessages(library(psych))
suppressMessages(library(DistatisR)) # 
suppressMessages(library(tidyr))
suppressMessages(library(magrittr))
suppressMessages(library(DistatisR))
suppressMessages(library(PTCA4CATA))
suppressMessages(library(ExPosition))
suppressMessages(library(InPosition))
suppressMessages(library(superheat))
suppressMessages(library(gridExtra))
suppressMessages(library(ggplotify))
suppressMessages(library(grid))
suppressMessages(library(viridis))
suppressMessages(library(pals))
# Read functions
tool.path <- "../tools/"
```

## Read data

```{r data, echo = FALSE, include = FALSE}
zmat.path <- "../../data/zmat/Gordon333"
parcelfile2read <- sapply(X = 1:10, FUN=function(x){sprintf("/sub-MSC%02d_sess1_10_r_z_cubes.Rdata",x)})
subj.name <- paste("sub", sprintf("%02d",1:10), sep="")

load(paste0(zmat.path,"/sub-MSC01_sess1_10_r_z_cubes.Rdata"))
matdim <- dim(cube$cube.z)

# rename communities
parcel.comm.path <- "../../data/parcel_community"
CommName <- read.csv(paste0(parcel.comm.path,"/gordon333_label.csv"))
# colnames(CommName) <- c("Comm","CommLabel","CommColor","CommLabel.short")

tab.design <- data.frame(subject = rep(subj.name, each = 4), session = rep(sprintf("sess%01d", 1:4), 10))

# create empty array
all.cubes <- array(dim = c(matdim[1:2], matdim[3]*4), 
                   dimnames = list(CommName$Community, 
                                   CommName$Community, 
                                   paste(tab.design$subject,tab.design$session, sep = ".")))

# read data
for (i in 1:length(subj.name)){
  load(paste0(zmat.path, parcelfile2read[i]))
  all.cubes[,,(4*(i-1)+1):(4*i)] <- cube$cube.z[,,2:5]
}

# Replace InF with 0 (DiSTATIS doesn't like it) - myc 20191113
all.cubes[is.infinite(all.cubes)] <- 0.99
```

This is a data cube of mean correlations: networks x networks x 4 sessions (2-5)

```{r check, echo = TRUE, include = TRUE}
# Dimensions
dim(all.cubes)
```



> Induce system-level changes (sim attack)

**Attack 1**

* In all *subjects* and Even-numbered *sessions* (2 & 4), Reduce within connectivity in Default Mode (Syslabel: 1) and Increase between connectivity of Default-FP (1_3) and Default_VAN (1_5).
    + identify within default connectivity, default-FP and default-VAN
    + Simulate reduced/increased connectivity by dividing edges that were identified by above and reduce 50% of connectivity (/2)

```{r simattack}

i_3 <- which(CommName$Community=="Default")
i_6 <- which(CommName$Community=="FrontoParietal")
i_15 <- which(CommName$Community=="DorsalAttn")

session2attack <- which(tab.design$session %in% c("sess2","sess4"))

all.cubes[i_3, i_3, session2attack] <-  all.cubes[i_3, i_3, session2attack]/2
all.cubes[i_3, i_6, session2attack] <-  all.cubes[i_3, i_6, session2attack] * 1.5
all.cubes[i_3, i_15, session2attack] <-  all.cubes[i_3, i_15, session2attack] * 1.5
all.cubes[i_6, i_3, session2attack] <-  all.cubes[i_6, i_3, session2attack] * 1.5
all.cubes[i_15, i_3, session2attack] <-  all.cubes[i_15, i_3, session2attack] * 1.5

```


Create colors based on design

```{r color, include = FALSE}
#--- create colors for participants
table.color <- list(oc = as.matrix(rep(cols25(10),each = 4)),
                    gc = as.matrix(rep(cols25(10))))
rownames(table.color$oc) <- dimnames(all.cubes)[[3]]
rownames(table.color$gc) <- subj.name

#--- create colors for sessions
session.color <- list(oc = as.matrix(rep(magma(10)[c(3,5,7,8)],10)),
                      gc = as.matrix(rep(magma(10)[c(3,5,7,8)])))
# plot(x = 1:10, y = rep(1,10), col = magma(10), pch = 19)
rownames(session.color$oc) <- dimnames(all.cubes)[[3]]
rownames(session.color$gc) <-  paste0("sess",1:4,sep = "")

#--- create colors for community in Gordon Parcels---# 
CommName$CommColor <- NA
CommName$CommColor[CommName$Community=="Auditory"]          <- "#9933FF"
CommName$CommColor[CommName$Community=="CinguloOperc"]      <- "#800080"
CommName$CommColor[CommName$Community=="CinguloParietal"]   <- "#2860b8" # Unkonwm Memory Retrieval
CommName$CommColor[CommName$Community=="Default"]           <- "#FF0000"
CommName$CommColor[CommName$Community=="DorsalAttn"]        <- "#00FF00"
CommName$CommColor[CommName$Community=="FrontoParietal"]    <- "#FFFF00"
CommName$CommColor[CommName$Community=="None"]              <- "#FFFFFF"
CommName$CommColor[CommName$Community=="RetrosplenialTemporal"] <- "#fff8b4" # Mediatl Temporal Parietal
CommName$CommColor[CommName$Community=="Salience"]          <- "#000000"
CommName$CommColor[CommName$Community=="SMhand"]            <- "#00FFFF"
CommName$CommColor[CommName$Community=="SMmouth"]           <- "#FF8000"
CommName$CommColor[CommName$Community=="VentralAttn"]       <- "#008080"
CommName$CommColor[CommName$Community=="Visual"]            <- "#0000FF"


```


Run DiSTATIS with the negative z-transformed correlation matrix (seen as covariance matrix) is equivalent to run DiSTATIS with distance matrices

```{r distatis}
distatis.res <- distatis(all.cubes, Distance = FALSE)
```

## Plot results

### Rv space

This results show how similar the tables are to one another.

#### Eigenvalues

```{r Rv.scree, echo = FALSE}
PlotScree(ev = distatis.res$res4Cmat$eigValues,
          title = "RV-map: Expained variance per dimension")
```

#### Factor scores

```{r Rv.f}
### Rv factor scores
rv.graph <- createFactorMap(distatis.res$res4Cmat$G,
                            axis1 = 1, axis2 = 2,
                            col.points = table.color$oc,
                            col.labels = table.color$oc,
                            text.cex = 2)
### Dimension labels for the Rv map
rv.labels <- createxyLabels.gen(lambda = distatis.res$res4Cmat$eigValues,
                                tau = distatis.res$res4Cmat$tau,
                                axisName = "Dimension ")
### Show plot
Rvmap <- rv.graph$zeMap + rv.labels
print(Rvmap)
```

### Compromise space

#### Eigenvalues

```{r scree, echo = FALSE}
PlotScree(ev = distatis.res$res4Splus$eigValues,
          title = "Compromise: Explained variance per dimension")
```

Set the components of interest
```{r set.coi}
x_cp <- 1
y_cp <- 2
```

#### Factor scores

```{r f, echo = FALSE}
f.graph <- createFactorMap(distatis.res$res4Splus$F,
                           axis1 = x_cp, axis2 = y_cp,
                           title = "Compromise - Factor scores (nodes): cp 1 & 2",
                           col.points = CommName$CommColor,
                           col.labels = CommName$CommColor,
                           alpha.points = .4, cex = 5, text.cex = 5)
f.graph.23 <- createFactorMap(distatis.res$res4Splus$F,
                              axis1 = 2, axis2 = 3,
                              title = "Compromise - Factor scores (nodes): cp 2 & 3",
                              col.points = CommName$CommColor,
                              col.labels = CommName$CommColor,
                              alpha.points = .4, cex = 5, text.cex = 5)
f.labels <- createxyLabels.gen(x_axis = x_cp, y_axis = y_cp,
                               lambda = distatis.res$res4Splus$eigValues,
                               tau = distatis.res$res4Splus$tau,
                               axisName = "Dimension ")
f.labels.23 <- createxyLabels.gen(x_axis = 2, y_axis = 3,
                                  lambda = distatis.res$res4Splus$eigValues,
                                  tau = distatis.res$res4Splus$tau,
                                  axisName = "Dimension ")
# Show plot
f01.F <- f.graph$zeMap_background + f.labels + f.graph$zeMap_dots
f01.F.cp3 <- f.graph.23$zeMap_background + f.labels.23 + f.graph.23$zeMap_dots
```

```{r plot_fig_f, echo=F, fig.height=8, fig.width= 16}
gridExtra::grid.arrange(as.grob(f01.F), as.grob(f01.F.cp3), ncol=2)
```

#### Partial factor scores

Component 1 & 2

```{r pf, include = FALSE}
pF <- distatis.res$res4Splus$PartialF

# mean pF for each subject
sub.pF <- apply(pF, c(1,2), function(y){
  aggregate(y, by = list(tab.design$subject), mean)$x
}) %>% aperm(c(2,3,1))
dimnames(sub.pF)[[3]] <- subj.name

# mean pF for each session
sess.pF <- apply(pF, c(1,2), function(y){
  aggregate(y, by = list(tab.design$session), mean)$x
}) %>% aperm(c(2,3,1))
dimnames(sess.pF)[[3]] <- sprintf("sess%01d", 1:4)

f.graph4sub <- createFactorMap(distatis.res$res4Splus$F,
                               axis1 = x_cp, axis2 = y_cp,
                               title = "Compromise - Factor scores (nodes): cp 1 & 2",
                               col.points = CommName$CommColor,
                               col.labels = CommName$CommColor,
                               pch = 17,
                               alpha.points = 0.7, cex = 4, text.cex = 4,
                               constraints = minmaxHelper4Partial(distatis.res$res4Splus$F,
                                                                  sub.pF))

pf.sub <- createPartialFactorScoresMap(distatis.res$res4Splus$F,
                                       sub.pF,
                                       axis1 = x_cp, axis2 = y_cp,
                                       colors4Blocks = table.color$gc,
                                       size.points = 3, size.labels = 3,
                                       alpha.points = .8, alpha.lines = .8, alpha.labels = .8,
                                       names4Partial = rownames(table.color$gc))

f.graph4sess <- createFactorMap(distatis.res$res4Splus$F,
                                axis1 = x_cp, axis2 = y_cp,
                                title = "Compromise - Factor scores (nodes): cp 1 & 2",
                                col.points = CommName$CommColor,
                                col.labels = CommName$CommColor,
                                pch = 17,
                                alpha.points = 0.7, cex = 4, text.cex = 4,
                                constraints = minmaxHelper4Partial(distatis.res$res4Splus$F,
                                                                   sess.pF))

pf.sess <- createPartialFactorScoresMap(distatis.res$res4Splus$F,
                                        sess.pF,
                                        axis1 = x_cp, axis2 = y_cp,
                                        colors4Blocks = session.color$gc,
                                        size.points = 3, size.labels = 4,
                                        alpha.points = .8, alpha.lines = .8, alpha.labels = 1,
                                        names4Partial = rownames(session.color$gc))


f02.FpF.sub <- f.graph4sub$zeMap_background + pf.sub$mapColByBlocks + f.graph4sub$zeMap_dots + f.labels
# f02.FpF.sub
f02.FpF.sess <- f.graph4sess$zeMap_background + pf.sess$mapColByBlocks + f.graph4sess$zeMap_dots + f.labels
# f02.FpF.sub
# f02.FpF.sess
```

```{r plot_fig_pF, echo=F, fig.height=8, fig.width= 16}
gridExtra::grid.arrange(as.grob(f02.FpF.sub), as.grob(f02.FpF.sess), ncol=2)
```

Component 2 & 3

```{r pf_cp3, include = FALSE}
f.graph4sub.cp3 <- createFactorMap(distatis.res$res4Splus$F,
                                   axis1 = 2, axis2 = 3,
                                   title = "Compromise - Factor scores (nodes): cp 2 & 3",
                                   col.points = CommName$CommColor,
                                   col.labels = CommName$CommColor,
                                   pch = 17,
                                   alpha.points = 0.7, cex = 4, text.cex = 4,
                                   constraints = minmaxHelper4Partial(distatis.res$res4Splus$F,
                                                                      sub.pF, axis1 = 2, axis2 = 3))

pf.sub.cp3 <- createPartialFactorScoresMap(distatis.res$res4Splus$F,
                                           sub.pF,
                                           axis1 = 2, axis2 = 3,
                                           colors4Blocks = table.color$gc,
                                           size.points = 3, size.labels = 3,
                                           alpha.points = .8, alpha.lines = .8, alpha.labels = .8,
                                           names4Partial = rownames(table.color$gc))

f.graph4sess.cp3 <- createFactorMap(distatis.res$res4Splus$F,
                                    axis1 = 2, axis2 = 3,
                                    title = "Compromise - Factor scores (nodes): cp 2 & 3",
                                    col.points = CommName$CommColor,
                                    col.labels = CommName$CommColor,
                                    pch = 17,
                                    alpha.points = 0.7, cex = 4, text.cex = 4,
                                    constraints = minmaxHelper4Partial(distatis.res$res4Splus$F,
                                                                       sess.pF, axis1 = 2, axis2 = 3))

pf.sess.cp3 <- createPartialFactorScoresMap(distatis.res$res4Splus$F,
                                            sess.pF,
                                            axis1 = 2, axis2 = 3,
                                            colors4Blocks = session.color$gc,
                                            size.points = 3, size.labels = 4,
                                            alpha.points = .8, alpha.lines = .8, alpha.labels = 1,
                                            names4Partial = rownames(session.color$gc))


f03.FpF.sub.cp3 <- f.graph4sub.cp3$zeMap_background + pf.sub.cp3$mapColByBlocks + f.graph4sub.cp3$zeMap_dots + f.labels.23
f03.FpF.sess.cp3 <- f.graph4sess.cp3$zeMap_background + pf.sess.cp3$mapColByBlocks + f.graph4sess.cp3$zeMap_dots + f.labels.23

```

```{r plot_fig_pF_cp3, echo=F, fig.height=8, fig.width= 16}
gridExtra::grid.arrange(as.grob(f03.FpF.sub.cp3), as.grob(f03.FpF.sess.cp3), ncol=2)
```



#### Mean partial factor scores

Component 1 & 2

```{r net.pf, include = FALSE}
fi <- distatis.res$res4Splus$F

# mean factor scores for each network
net.fi <- getMeans(fi, factor = CommName$Community)

# network colors
CommColor.gc <- unique((CommName[,c("Community", "CommColor")]))
rownames(CommColor.gc) <- CommColor.gc$Community

# get mean subjects' partial factor scores of each network
get.subpF.net <- apply(sub.pF, 3, function(x){
  getMeans(x, CommName$Community)
})
sub.pF.net <- array(unlist(get.subpF.net), dim = c(dim(get.subpF.net[[1]]), length(get.subpF.net)), dimnames = list(rownames(get.subpF.net$sub01), colnames(get.subpF.net$sub01), names(get.subpF.net))) 

# get mean sessions' partial factor scores of each network
get.sesspF.net <- apply(sess.pF, 3, function(x){
  getMeans(x, CommName$Community)
})
sess.pF.net <- array(unlist(get.sesspF.net), dim = c(dim(get.sesspF.net[[1]]), length(get.sesspF.net)), dimnames = list(rownames(get.sesspF.net$sess1), colnames(get.sesspF.net$sess1), names(get.sesspF.net)))

netf.graph4sub <- createFactorMap(net.fi,
                           axis1 = x_cp, axis2 = y_cp,
                           title = "Compromise - Factor scores (networks): cp 1 & 2",
                           col.points = CommColor.gc[rownames(net.fi), "CommColor"],
                           col.labels = CommColor.gc[rownames(net.fi), "CommColor"],
                           pch = 17,
                           alpha.points = 0.7, cex = 4, text.cex = 4,
                           constraints = minmaxHelper4Partial(net.fi,
                                                              sub.pF.net))

netpf.sub <- createPartialFactorScoresMap(net.fi,
                                       sub.pF.net,
                                       axis1 = x_cp, axis2 = y_cp,
                                       colors4Blocks = table.color$gc,
                                       size.points = 3, size.labels = 3,
                                       alpha.points = .8, alpha.lines = .8, alpha.labels = .8,
                                       names4Partial = rownames(table.color$gc))

netf.graph4sess <- createFactorMap(net.fi,
                           axis1 = x_cp, axis2 = y_cp,
                           title = "Compromise - Factor scores (networks): cp 1 & 2",
                           col.points = CommColor.gc[rownames(net.fi), "CommColor"],
                           col.labels = CommColor.gc[rownames(net.fi), "CommColor"],
                           pch = 17,
                           alpha.points = 0.7, cex = 4, text.cex = 4,
                           constraints = minmaxHelper4Partial(net.fi,
                                                              sess.pF.net))

netpf.sess <- createPartialFactorScoresMap(net.fi,
                                       sess.pF.net,
                                       axis1 = x_cp, axis2 = y_cp,
                                       colors4Blocks = session.color$gc,
                                       size.points = 3, size.labels = 4,
                                       alpha.points = .8, alpha.lines = .8, alpha.labels = 1,
                                       names4Partial = rownames(session.color$gc))


f02.netFpF.sub <- netf.graph4sub$zeMap_background + netpf.sub$mapColByBlocks + netf.graph4sub$zeMap_dots + f.labels
# f02.netFpF.sub
f02.netFpF.sess <- netf.graph4sess$zeMap_background + netpf.sess$mapColByBlocks + netf.graph4sess$zeMap_dots + f.labels
# f02.netFpF.sub
# f02.netFpF.sess
```

```{r plot_fig_netpF, echo=F, fig.height=8, fig.width= 16}
gridExtra::grid.arrange(as.grob(f02.netFpF.sub), as.grob(f02.netFpF.sess), ncol=2)
```

Component 2 & 3

```{r net.pf_cp3, include = FALSE}
netf.graph4sub.cp3 <- createFactorMap(net.fi,
                           axis1 = 2, axis2 = 3,
                           title = "Compromise - Factor scores (networks): cp 1 & 2",
                           col.points = CommColor.gc[rownames(net.fi), "CommColor"],
                           col.labels = CommColor.gc[rownames(net.fi), "CommColor"],
                           pch = 17,
                           alpha.points = 0.7, cex = 4, text.cex = 4,
                           constraints = minmaxHelper4Partial(net.fi,
                                                              sub.pF.net, 
                                                              axis1 = 2, axis2 = 3))

netpf.sub.cp3 <- createPartialFactorScoresMap(net.fi,
                                       sub.pF.net,
                                       axis1 = 2, axis2 = 3,
                                       colors4Blocks = table.color$gc,
                                       size.points = 3, size.labels = 3,
                                       alpha.points = .8, alpha.lines = .8, alpha.labels = .8,
                                       names4Partial = rownames(table.color$gc))

netf.graph4sess.cp3 <- createFactorMap(net.fi,
                           axis1 = 2, axis2 = 3,
                           title = "Compromise - Factor scores (networks): cp 1 & 2",
                           col.points = CommColor.gc[rownames(net.fi), "CommColor"],
                           col.labels = CommColor.gc[rownames(net.fi), "CommColor"],
                           pch = 17,
                           alpha.points = 0.7, cex = 4, text.cex = 4,
                           constraints = minmaxHelper4Partial(net.fi,
                                                              sess.pF.net, 
                                                              axis1 = 2, axis2 = 3))

netpf.sess.cp3 <- createPartialFactorScoresMap(net.fi,
                                       sess.pF.net,
                                       axis1 = 2, axis2 = 3,
                                       colors4Blocks = session.color$gc,
                                       size.points = 3, size.labels = 4,
                                       alpha.points = .8, alpha.lines = .8, alpha.labels = 1,
                                       names4Partial = rownames(session.color$gc))


f03.netFpF.sub.cp3 <- netf.graph4sub.cp3$zeMap_background + netpf.sub.cp3$mapColByBlocks + netf.graph4sub.cp3$zeMap_dots + f.labels.23
# f02.netFpF.sub
f03.netFpF.sess.cp3 <- netf.graph4sess.cp3$zeMap_background + netpf.sess.cp3$mapColByBlocks + netf.graph4sess.cp3$zeMap_dots + f.labels.23
```

```{r plot_fig_pF_cp3_net, echo=F, fig.height=8, fig.width= 16}
gridExtra::grid.arrange(as.grob(f03.netFpF.sub.cp3), as.grob(f03.netFpF.sess.cp3), ncol=2)
```


```{r save, echo = FALSE, include=FALSE}
save.image(file = "cfDiSTATIS_simattack_NOTTMS_GordonParcel.RData")
```
